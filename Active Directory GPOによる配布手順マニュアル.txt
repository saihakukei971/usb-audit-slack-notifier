# Active Directory GPOによる配布手順マニュアル

## 概要
このマニュアルでは、USB-Audit-Slack-Notifierを Active Directory環境で全端末に配布・展開する方法を説明します。グループポリシーオブジェクト（GPO）を使用して、ドメイン参加済みの全Windows端末に自動実行を設定します。

## 前提条件

### 環境要件
- Active Directoryドメインコントローラー（Windows Server 2012 R2以上）
- ドメイン参加済みのWindows端末（Windows 10/11 Pro以上推奨）
- 管理者権限を持つアカウント

### 必要ファイル
- `serial_ports_logger_slack.exe`（PyInstallerでビルド済み）
- `slack_settings.toml`（Slack APIトークンとチャンネル設定済み）
- `run_logger.bat`（実行用バッチファイル）

## 配布・展開手順

### 1. 共有フォルダの準備

1. ドメインコントローラーまたはファイルサーバーに共有フォルダを作成します：
   ```
   \\server\serial_logger_slack\
   ```

2. 共有フォルダに必要なファイルを配置します：
   ```
   \\server\serial_logger_slack\
   ├─ serial_ports_logger_slack.exe
   ├─ slack_settings.toml
   └─ run_logger.bat
   ```

3. 共有フォルダのアクセス権を設定します：
   - 「Domain Computers」グループに「読み取り」権限を付与
   - 「Domain Admins」グループに「フルコントロール」権限を付与

### 2. run_logger.batの内容確認

`run_logger.bat`の内容が以下のようになっていることを確認します：

```bat
@echo off
cd /d %~dp0
start /min serial_ports_logger_slack.exe --silent
```

### 3. GPOの作成と設定

1. ドメインコントローラーで「グループポリシー管理コンソール」を開きます：
   ```
   gpmc.msc
   ```

2. 「フォレスト」→「ドメイン」→「あなたのドメイン名」を右クリックし、「このドメインにGPOを作成し、ここにリンクする」を選択します。

3. 名前を入力します（例：`USB-Serial-Logger-Deployment`）。

4. 作成したGPOを右クリックし、「編集」を選択します。

5. 「コンピュータの構成」→「ポリシー」→「Windowsの設定」→「スクリプト（スタートアップ/シャットダウン）」→「スタートアップ」をダブルクリックします。

6. 「追加」をクリックし、以下の情報を入力します：
   - スクリプト名：`\\server\serial_logger_slack\run_logger.bat`
   - スクリプトのパラメータ：（空白のまま）

7. 「OK」→「適用」→「OK」の順にクリックして設定を保存します。

### 4. GPOのセキュリティフィルタリング設定（オプション）

特定のコンピュータグループにのみ適用する場合：

1. GPO管理コンソールで作成したGPOを選択します。
2. 「セキュリティフィルタリング」セクションで「追加」をクリックします。
3. 対象のセキュリティグループを選択し、「OK」をクリックします。

### 5. GPOの適用確認

1. ドメインコントローラーで以下のコマンドを実行し、GPOを強制的に更新します：
   ```
   gpupdate /force
   ```

2. テスト用のクライアントPCを再起動し、GPOが適用されることを確認します。

3. テスト用PCのSlack通知が正常に行われることを確認します：
   - 指定されたSlackチャンネルにCSVファイルが添付されている
   - 「YYYY年MM月DD日のシリアルポートの一覧取得をしました。ご確認をお願いいたします。」という定型メッセージが表示されている

### 6. トラブルシューティング

#### GPOが適用されない場合

1. クライアントPCで以下のコマンドを実行し、適用されているGPOを確認します：
   ```
   gpresult /r
   ```

2. 適用されていない場合は、以下を確認します：
   - PCがドメインに正常に参加しているか
   - GPOのリンクが有効になっているか
   - セキュリティフィルタリングの設定が正しいか

#### Slack通知が送信されない場合

1. 共有フォルダの`serial_logger.log`ファイルを確認してエラーメッセージを特定します。

2. 以下の点を確認します：
   - `slack_settings.toml`のトークンとチャンネル設定が正しいか
   - ネットワーク接続に問題がないか
   - クライアントPCが共有フォルダにアクセスできるか

### 7. 定期実行の設定（オプション）

PC起動時だけでなく定期的に実行する場合は、タスクスケジューラでタスクを作成します：

1. GPO編集画面で「コンピュータの構成」→「設定」→「コントロールパネルの設定」→「スケジュールされたタスク」を選択します。

2. 右クリックして「新規」→「スケジュールされたタスク」を選択します。

3. 以下の設定を行います：
   - タスク名：`SerialPortsLoggerTask`
   - 実行ファイル：`\\server\serial_logger_slack\run_logger.bat`
   - 実行アカウント：`NT AUTHORITY\SYSTEM`
   - 実行スケジュール：「毎日」または必要な頻度
   - 実行時間：業務時間内（例：10:00）

## セキュリティ上の注意点

1. `slack_settings.toml`ファイルは通常ユーザーが編集できないよう、共有フォルダのNTFSアクセス権で「読み取り専用」に設定してください。

2. Slackトークンは定期的に更新し、トークンの権限は必要最小限（files:write, chat:write）に制限することを推奨します。

3. 共有フォルダへのアクセスログを有効にし、不正アクセスを監視してください。

## まとめ

このマニュアルでは、USB-Audit-Slack-NotifierをActive Directory GPOを使って大規模環境に展開する方法を説明しました。この設定により、ドメイン参加済みの全Windows端末で自動的にUSBシリアルデバイス情報が収集され、Slackチャンネルに通知されるようになります。

定期的なメンテナンスとして、Slackトークンの更新、ログファイルの確認、そして必要に応じたスクリプトのアップデートを行うことをお勧めします。